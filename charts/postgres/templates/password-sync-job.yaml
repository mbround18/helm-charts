apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-password-sync
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  template:
    spec:
      serviceAccountName: default
      containers:
      - name: password-sync
        image: alpine:3.22
        command:
        - /bin/sh
        - -c
        - |
          set -e
          apk add --no-cache curl
          curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.29.2/bin/linux/amd64/kubectl
          chmod +x kubectl
          mv kubectl /usr/local/bin/
          
          echo "Waiting for postgres-0 to be ready..."
          kubectl wait --for=condition=Ready pod/postgres-0 --timeout=120s
          
          echo "Updating password for user {{ .Values.postgresql.user }}..."
          # Pipe the SQL command to avoid exposing password in process args
          # Use the superuser secret to authenticate if needed, or rely on local trust if configured
          # Here we assume we can exec as the postgres user inside the container who is superuser
          echo "ALTER USER {{ .Values.postgresql.user }} WITH PASSWORD '$POSTGRES_PASSWORD';" | kubectl exec -i postgres-0 -- psql -U {{ .Values.postgresql.superuser | default "postgres" }}
          
          echo "Password updated successfully."
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.passwordSecret }}
              key: POSTGRES_PASSWORD
      restartPolicy: OnFailure
