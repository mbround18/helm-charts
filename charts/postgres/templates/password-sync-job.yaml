apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-password-sync
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  template:
    spec:
      serviceAccountName: default
      initContainers:
      - name: wait-for-postgres
        image: alpine:3.22
        env:
        - name: PGUSER
          value: {{ .Values.postgresql.superuser | default "postgres" }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.secrets.superuserPassword.name }}
              key: {{ .Values.secrets.superuserPassword.key }}
        command:
        - sh
        - -c
        - |
          apk add --no-cache postgresql-client
          echo "Waiting for PostgreSQL to be ready on postgres-0..."
          until pg_isready -h postgres-0.postgres -p 5432 -U "$PGUSER"; do
            echo "PostgreSQL not ready, retrying..."
            sleep 5
          done
          echo "PostgreSQL is accepting connections."
      containers:
      - name: password-sync
        image: alpine:3.22
        command:
        - /bin/sh
        - -c
        - |
          set -e
          apk add --no-cache curl
          curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.29.2/bin/linux/amd64/kubectl
          chmod +x kubectl
          mv kubectl /usr/local/bin/
          
          echo "Waiting for postgres-0 to be ready..."
          kubectl wait --for=condition=Ready pod/postgres-0 --timeout=120s
          
          echo "Updating password for user {{ .Values.postgresql.user }}..."
          # Pipe the SQL command to avoid exposing password in process args
          # Use the superuser secret to authenticate if needed, or rely on local trust if configured
          # Here we assume we can exec as the postgres user inside the container who is superuser
          echo "ALTER USER {{ .Values.postgresql.user }} WITH PASSWORD '$POSTGRES_PASSWORD';" | kubectl exec -i postgres-0 -- psql -U {{ .Values.postgresql.superuser | default "postgres" }}
          
          echo "Password updated successfully."
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.secrets.password.name }}
              key: {{ .Values.secrets.password.key }}
      restartPolicy: OnFailure
